# DonationAlerts для Streamer.bot

[![GitHub All Releases](https://img.shields.io/github/downloads/play-code-live/streamer.bot-donationAlerts/total.svg)](https://github.com/play-code-live/streamer.bot-donationAlerts/releases) [![GitHub release](https://img.shields.io/github/release/play-code-live/streamer.bot-donationAlerts.svg)](https://github.com/play-code-live/streamer.bot-donationAlerts/releases)

Данный модуль является набором действий и комманд для интеграции с DonationAlerts.

## Установка

> **Важно!** Если у вас уже есть подключенная интеграция более старой версии, воспользуйтесь инструкцией по обновлению

1. Загрузите свежую версию файла импорта **install.sb** со [страницы релизов](https://github.com/play-code-live/streamer.bot-donationAlerts/releases)
2. Откройте Streamer.bot и нажмите кнопку Import
3. Перетащите курсором мыши загруженный файл **install.sb** в область **Import String**, или скопируйте его содержимое и вставьте вручную
4. Нажмите кнопку Import
5. Перейдите на вкладку **Commands** и поставьте галочку **Enabled** у команд `!da_connect` и `!da_start`
6. Перейдите в чат вашего канала и введите команду `!da_connect`. В браузере откроется страница для авторизации в DonationAlerts, после чего интеграция запуститься и подключится в автозагрузку

## Обновление

1. На вкладке **Actions** удалите следующие действия, при их наличии:
   * `-- DonationAlerts Autorization`
   * `-- DonationAlerts AutoStart`
   * `-- DonationAlerts Background Watcher`
   * `-- DonationAlerts Code`
   * `-- DonationAlerts Enable Background Watcher`
   * `-- DonationAlerts Get Socket Token`
   * `-- DonationAlerts Init`
2. Загрузите свежую версию файла импорта **update.sb** со [страницы релизов](https://github.com/play-code-live/streamer.bot-donationAlerts/releases)
3. Перезагрузите Streamer.bot (необходимо для завершения процесса `-- DonationAlerts Background Watcher`)
4. Откройте Streamer.bot и нажмите кнопку Import
5. Перетащите курсором мыши загруженный файл **update.sb** в область **Import String**, или скопируйте его содержимое и вставьте вручную
6. Нажмите кнопку Import
7. Перезагрузите Streamer.bot или перейдите в чат вашего канала и введите команду `!da_start`. Если потребуется авторизация - введите `!da_connect`

## Структура

Весь список команд можно поделить на две условные группы:

### Служебные действия

Все служебные действия размещены в группе **DonationAlerts** и имеют префикс `--DonationAlerts`. Все они плотно связаны друг с другом и не могут быть переименованны без нарушения работоспособности.

> **Важно!** Не переименовывайте служебные действия! Они имеют высокую зависимость друг от друга

* `--DonationAlerts Code` - Содержит основной код интеграции, который вызывается посредством **Call C# Method** в Streamer.bot
* `--DonationAlerts Authorization` - Основная логика авторизации в сервисе. Вызывается вводом команды `!da_connect`
* `--DonationAlerts Enable Background Watcher` - Активирует действия `Init` и `Background Watcher` для работы интеграции и автоматического запуска.
* `--DonationAlerts Background Watcher` - Фоновое действие, отслеживающее появление новых донатов. Всегда должно находиться в очереди. Для ручной постановки в очередь, введите команду `!da_start`
* `--DonationAlerts Autostart` - Обеспечивает безопасный запуск кода отслеживания донатов
* `--DonationAlerts Init` - Автоматически запускает код отслеживания донатов на запуске streamer.bot

### Действия-обработчики

#### Обработчики доната

Действия обработчики редактируются пользователем, для достижения желаемого эффекта реакции на донат. Однако, они имеют строго заданный шаблон именования.

Вся основная обработка донатов выполняется в действии `DonationHandler_Default`. Из него вы можете развести логику в зависимости от диапазонов сумм. Однако, для точной суммы, есть другой подход...

Если вы хотите обработать донат на конкретную сумму, вам необходимо создать действие `DonationHandler_SUM`, где вместо `SUM` вы указываете желаемое число.

#### Финализирующий обработчик доната

Если у вас заведено множество обработчиков для конкретных сумм, и в конце каждого приходится выполнять дополнительные операции или вызывать Action'ы - вы можете реализовать общую логику в специальном экшене `DonationHandler_After`.

`DonationHandler_After` выполняется в самом конце после любого другого обработчика доната, вне зависимости от того, был ли это `Default` обработчик или обработчик конкретной суммы.

#### Обработчик целей сбора

Если вы используете цели сбора на DA и хотите использовать информацию об их прогрессе, вы можете воспользоваться ей через Action `DonationHandler_GoalHandler`. Он вызывается на каждом изменении прогресса цели сбора, а так же при ключевых изменениях целей: отключение, установка по-умолчанию и т.д.

## Аргументы

### Донат

Каждое обработанное событие доната сопровождается следующими аргументами:

| Аргумент             | Описание                                                                                               |
| -------------------- | ------------------------------------------------------------------------------------------------------ |
| `daUsername`         | Имя пользователя. Не может быть пустым. В случаях анонимной поддержки подставляется значение Anonymous |
| `daType`             | Тип сообщения в донате. Может принимать значения: `text` или `audio`                                   |
| `daMessage`          | Если `daType == text`. Сообщение доната. Может быть пустым                                             |
| `daAudio`            | Если `daType == audio`. Путь до файла с голосовым донатом                                              |
| `daAmount`           | Сумма поддержки в валюте зрителя                                                                       |
| `daCurrency`         | Выбранная для поддержки валюта                                                                         |
| `daAmountConverteed` | Сумма поддержки в валюте аккаунта стримера                                                             |

### Обновление цели

Каждое обработанное событие, изменяющее состояние целей сбора (включая отключение цели), сопровождается следующими аргументами:

| Аргумент         | Описание                                                |
| ---------------- | ------------------------------------------------------- |
| `daGoalIsActive` | Является ли цель активной. Принимает `False` или `True` |
| `daGoalTitle`    | Заголовок цели сбора                                    |
| `daGoalCurrency` | Основная валюта цели сбора                              |
| `daGoalCurrent`  | Текущее значение прогресса цели сбора                   |
| `daGoalTarget`   | Целевое значение                                        |

## Автор

**play_code** <info@play-code.info>

https://twitch.tv/play_code
